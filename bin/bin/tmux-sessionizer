#!/usr/bin/env bash

if [[ $# -eq 1 ]]; then
    selected=$1
else
    # Get all directories from zoxide
    mapfile -t directories < <(zoxide query -l)

    # Get all existing tmux sessions into an associative array for O(1) lookup
    declare -A sessions_map
    while IFS= read -r session_name; do
        sessions_map["$session_name"]=1
    done < <(tmux list-sessions -F "#{session_name}" 2>/dev/null)

    # Build list with indicators, sorting open sessions first
    declare -a open_dirs
    declare -a closed_dirs

    for dir in "${directories[@]}"; do
        session_name=$(basename "$dir" | tr . _)

        if [[ -n "${sessions_map[$session_name]}" ]]; then
            open_dirs+=("* $dir")
        else
            closed_dirs+=("  $dir")
        fi
    done

    # Combine lists with open sessions first
    all_options=("${open_dirs[@]}" "${closed_dirs[@]}")

    if [[ ${#all_options[@]} -eq 0 ]]; then
        exit 0
    fi

    # Use fzf to select, with preview showing the indicator
    selection=$(printf '%s\n' "${all_options[@]}" | fzf --preview 'echo {}' --preview-window=right:0)

    if [[ -z $selection ]]; then
        exit 0
    fi

    # Extract the path (remove the indicator)
    selected="${selection#* }"
fi

selected_name=$(basename "$selected" | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2>/dev/null; then
    tmux new-session -ds $selected_name -c $selected
fi

tmux switch-client -t $selected_name

# vim: filetype=sh:tabstop=4:shiftwidth=4:expandtab:
